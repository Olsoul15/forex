{% extends "base.html" %}

{% block extra_head %}
<style>
    .broker-card {
        transition: transform 0.3s;
        height: 100%;
    }
    .broker-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .broker-logo {
        max-height: 60px;
        max-width: 180px;
        object-fit: contain;
        margin-bottom: 15px;
    }
    .connected-badge {
        position: absolute;
        top: 10px;
        right: 10px;
    }
    .api-key-input {
        font-family: monospace;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Broker Connections</h1>
        <div>
            <button class="btn btn-outline-secondary" id="refreshConnectionsBtn">
                <i class="bi bi-arrow-clockwise"></i> Refresh Connections
            </button>
        </div>
    </div>

    <div class="alert alert-info">
        <i class="bi bi-info-circle-fill"></i>
        <strong>Note:</strong> To comply with broker API license agreements, you must use your own personal API tokens. 
        Your credentials are securely stored and used only for connecting to your accounts.
    </div>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-5" id="brokerCards">
        {% for broker in brokers %}
        <div class="col">
            <div class="card broker-card">
                {% if broker.connected %}
                <span class="badge bg-success connected-badge">Connected</span>
                {% endif %}
                <div class="card-body text-center">
                    <img src="{{ broker.logo }}" alt="{{ broker.name }} Logo" class="broker-logo mb-3">
                    <h5 class="card-title">{{ broker.name }}</h5>
                    <p class="card-text">{{ broker.description }}</p>
                    <button class="btn btn-primary w-100 configure-broker-btn" 
                            data-broker-id="{{ broker.id }}"
                            data-broker-name="{{ broker.name }}">
                        {% if broker.connected %}
                        Manage Connection
                        {% else %}
                        Connect
                        {% endif %}
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- OANDA Connection Modal -->
<div class="modal fade" id="oandaModal" tabindex="-1" aria-labelledby="oandaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="oandaModalLabel">Connect to OANDA</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="oandaForm">
                    <div class="mb-3">
                        <label for="oandaEnvironment" class="form-label">Environment</label>
                        <select class="form-select" id="oandaEnvironment" name="environment" required>
                            <option value="practice">Practice</option>
                            <option value="live">Live</option>
                        </select>
                        <div class="form-text">Select Practice for demo accounts or Live for real trading.</div>
                    </div>
                    <div class="mb-3">
                        <label for="oandaToken" class="form-label">API Access Token</label>
                        <input type="password" class="form-control api-key-input" id="oandaToken" name="access_token" required>
                        <div class="form-text">
                            Your personal OANDA API token. You can generate this in your 
                            <a href="https://www.oanda.com/account/profile/personal-access-tokens" target="_blank">OANDA account settings</a>.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="oandaDefaultAccount" class="form-label">Default Account ID (Optional)</label>
                        <input type="text" class="form-control" id="oandaDefaultAccount" name="default_account_id">
                        <div class="form-text">If you have multiple accounts, specify which one to use by default.</div>
                    </div>
                    <div id="oandaConnectionStatus"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="oandaDisconnectBtn" style="display: none;">Disconnect</button>
                <button type="button" class="btn btn-primary" id="oandaConnectBtn">Connect</button>
                <button type="button" class="btn btn-primary" id="oandaTestBtn">Test Connection</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize broker connection status
        checkBrokerConnections();
        
        // Handle broker configuration button clicks
        document.querySelectorAll('.configure-broker-btn').forEach(button => {
            button.addEventListener('click', function() {
                const brokerId = this.getAttribute('data-broker-id');
                const brokerName = this.getAttribute('data-broker-name');
                
                if (brokerId === 'oanda') {
                    showOandaModal();
                }
                // Add more broker types as needed
            });
        });
        
        // Handle OANDA connection
        document.getElementById('oandaConnectBtn').addEventListener('click', function() {
            connectOanda();
        });
        
        // Handle OANDA test connection
        document.getElementById('oandaTestBtn').addEventListener('click', function() {
            testOandaConnection();
        });
        
        // Handle OANDA disconnection
        document.getElementById('oandaDisconnectBtn').addEventListener('click', function() {
            disconnectOanda();
        });
        
        // Handle refresh connections button
        document.getElementById('refreshConnectionsBtn').addEventListener('click', function() {
            checkBrokerConnections();
        });
    });
    
    // Show OANDA modal with existing credentials if available
    function showOandaModal() {
        // Fetch existing credentials
        fetch('/api/brokers/credentials?broker_type=oanda')
            .then(response => response.json())
            .then(data => {
                if (data.exists) {
                    // Pre-fill form with existing data
                    document.getElementById('oandaEnvironment').value = data.environment || 'practice';
                    document.getElementById('oandaToken').value = data.access_token || '';
                    document.getElementById('oandaDefaultAccount').value = data.default_account_id || '';
                    document.getElementById('oandaDisconnectBtn').style.display = 'block';
                } else {
                    // Reset form
                    document.getElementById('oandaForm').reset();
                    document.getElementById('oandaDisconnectBtn').style.display = 'none';
                }
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('oandaModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error fetching OANDA credentials:', error);
                showAlert('error', 'Failed to fetch OANDA credentials');
            });
    }
    
    // Connect to OANDA
    function connectOanda() {
        const form = document.getElementById('oandaForm');
        const statusDiv = document.getElementById('oandaConnectionStatus');
        
        // Get form data
        const formData = new FormData(form);
        const credentials = {
            broker_type: 'oanda',
            access_token: formData.get('access_token'),
            environment: formData.get('environment'),
            default_account_id: formData.get('default_account_id') || null
        };
        
        // Show loading status
        statusDiv.innerHTML = '<div class="alert alert-info">Connecting to OANDA...</div>';
        
        // Send request to save credentials
        fetch('/api/brokers/credentials', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ credentials }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusDiv.innerHTML = '<div class="alert alert-success">Successfully connected to OANDA!</div>';
                document.getElementById('oandaDisconnectBtn').style.display = 'block';
                setTimeout(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('oandaModal'));
                    modal.hide();
                    checkBrokerConnections();
                }, 1500);
            } else {
                statusDiv.innerHTML = `<div class="alert alert-danger">Failed to connect: ${data.message}</div>`;
            }
        })
        .catch(error => {
            console.error('Error connecting to OANDA:', error);
            statusDiv.innerHTML = '<div class="alert alert-danger">Connection failed. Please check your credentials.</div>';
        });
    }
    
    // Test OANDA connection
    function testOandaConnection() {
        const form = document.getElementById('oandaForm');
        const statusDiv = document.getElementById('oandaConnectionStatus');
        
        // Get form data
        const formData = new FormData(form);
        const credentials = {
            broker_type: 'oanda',
            access_token: formData.get('access_token'),
            environment: formData.get('environment'),
            default_account_id: formData.get('default_account_id') || null
        };
        
        // Show loading status
        statusDiv.innerHTML = '<div class="alert alert-info">Testing connection...</div>';
        
        // Send request to test credentials
        fetch('/api/brokers/credentials', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ credentials }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusDiv.innerHTML = '<div class="alert alert-success">Connection test successful!</div>';
            } else {
                statusDiv.innerHTML = `<div class="alert alert-danger">Connection test failed: ${data.message}</div>`;
            }
        })
        .catch(error => {
            console.error('Error testing OANDA connection:', error);
            statusDiv.innerHTML = '<div class="alert alert-danger">Connection test failed. Please check your credentials.</div>';
        });
    }
    
    // Disconnect from OANDA
    function disconnectOanda() {
        const statusDiv = document.getElementById('oandaConnectionStatus');
        
        // Show loading status
        statusDiv.innerHTML = '<div class="alert alert-info">Disconnecting...</div>';
        
        // Send request to delete credentials
        fetch('/api/brokers/credentials?broker_type=oanda', {
            method: 'DELETE',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusDiv.innerHTML = '<div class="alert alert-success">Successfully disconnected!</div>';
                document.getElementById('oandaDisconnectBtn').style.display = 'none';
                document.getElementById('oandaForm').reset();
                setTimeout(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('oandaModal'));
                    modal.hide();
                    checkBrokerConnections();
                }, 1500);
            } else {
                statusDiv.innerHTML = `<div class="alert alert-danger">Failed to disconnect: ${data.message}</div>`;
            }
        })
        .catch(error => {
            console.error('Error disconnecting from OANDA:', error);
            statusDiv.innerHTML = '<div class="alert alert-danger">Disconnection failed.</div>';
        });
    }
    
    // Check broker connections
    function checkBrokerConnections() {
        // Fetch OANDA connection status
        fetch('/api/brokers/credentials?broker_type=oanda')
            .then(response => response.json())
            .then(data => {
                // Find OANDA card
                const brokerCards = document.getElementById('brokerCards');
                const oandaCard = brokerCards.querySelector('[data-broker-id="oanda"]');
                
                if (oandaCard) {
                    // Update button text
                    const button = oandaCard.querySelector('.configure-broker-btn');
                    if (data.exists) {
                        button.textContent = 'Manage Connection';
                        
                        // Add connected badge if not already present
                        let badge = oandaCard.closest('.card').querySelector('.connected-badge');
                        if (!badge) {
                            badge = document.createElement('span');
                            badge.className = 'badge bg-success connected-badge';
                            badge.textContent = 'Connected';
                            oandaCard.closest('.card').prepend(badge);
                        }
                    } else {
                        button.textContent = 'Connect';
                        
                        // Remove connected badge if present
                        const badge = oandaCard.closest('.card').querySelector('.connected-badge');
                        if (badge) {
                            badge.remove();
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error checking OANDA connection:', error);
            });
    }
    
    // Show alert
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstChild);
        
        setTimeout(() => {
            alertDiv.classList.remove('show');
            setTimeout(() => alertDiv.remove(), 300);
        }, 5000);
    }
</script>
{% endblock %}
